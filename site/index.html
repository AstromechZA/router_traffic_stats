<!DOCTYPE html>
<html>
    <head>
        <title>Traffic Graph</title>
    </head>
    <body>

        <div id="GraphContainer_traffic" style="height: 800px"></div>

        <div id="ConnectedDevices"></div>

        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://code.highcharts.com/stock/highstock.js"></script>
        <script src="tick.min.js"></script>
        <script src="traffic.js"></script>
        <script src="devices.js"></script>
        <script src="pings.js"></script>
        <script type="text/javascript">
            function bytes(bytes, label) {
                if (bytes==0) return '0';
                var s = ['bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
                var e = Math.floor(Math.log(bytes)/Math.log(1024));
                var value = ((bytes/Math.pow(1024, Math.floor(e))).toFixed(2));
                e = (e<0) ? (-e) : e;
                if (label) value += ' ' + s[e];
                return value;
            }

            function speed(bits, label) {
                if (bits==0) return '0';
                var s = ['bps', 'Kbps', 'Mbps', 'Gbps'];
                var e = Math.floor(Math.log(bits)/Math.log(1024));
                var value = ((bits/Math.pow(1024, Math.floor(e))).toFixed(2));
                e = (e<0) ? (-e) : e;
                if (label) value += ' ' + s[e];
                return value;
            }

            function time(ms) {
                return ms.toFixed(2) + ' ms'
            }

            $(document).ready(function(){
                var traffic_data_c = traffic_data || []
                var device_data_c = device_data || []
                var ping_data_c = ping_data || []

                var KB = 1024
                var MB = 1024*1024

                diff_traffic_data = []
                total_traffic_data = []
                download_traffic_data = []
                upload_traffic_data = []
                for (var i = 0; i < traffic_data_c.length; i++) {
                    dt = tick(traffic_data_c[i][0]*1000)
                    total_traffic_data.push({
                        x: dt.valueOf(),
                        y: traffic_data_c[i][1][2]
                    })
                    download_traffic_data.push({
                        x: dt.valueOf(),
                        y: traffic_data_c[i][1][1]
                    })
                    upload_traffic_data.push({
                        x: dt.valueOf(),
                        y: traffic_data_c[i][1][0]
                    })
                    if (i > 0) {
                        var lastt = tick(traffic_data_c[i-1][0]).valueOf()
                        var last = traffic_data_c[i-1][1][1]
                        var currentt = tick(traffic_data_c[i][0]).valueOf()
                        var current = traffic_data_c[i][1][1]
                        var diff = current - last
                        if (diff < 0) diff = current

                        var t = currentt - lastt

                        diff_traffic_data.push({
                            x: dt.valueOf(),
                            y: diff*8.0/t
                        })
                    }
                };


                eventflags = []

                var events = device_data_c['events']
                for (var i = 0; i < events.length; i++) {
                    dt = tick(events[i][0]*1000)
                    eventflags.push({
                        x: dt.valueOf(),
                        title: '!',
                        text: events[i][1]
                    })
                };

                $('#ConnectedDevices').html('Currently Connected: ' + device_data_c['devices'].join(', '))

                average_ping_remote_data = []
                average_ping_local_data = []
                for (var i = 0; i < ping_data_c.length; i++) {
                    dt = tick(ping_data_c[i]['time']*1000)
                    average_ping_remote_data.push({
                        x: dt.valueOf(),
                        y: ping_data_c[i]['remote'][1]
                    })
                    average_ping_local_data.push({
                        x: dt.valueOf(),
                        y: ping_data_c[i]['local'][1]
                    })
                };

                Highcharts.setOptions({
                    global: {
                        useUTC: false
                    }
                })

                $('#GraphContainer_traffic').highcharts('StockChart', {
                    title : {
                        text : 'Network Totals'
                    },

                    xAxis: {
                        ordinal: false
                    },

                    series : [{
                        name : 'Total traffic',
                        data : total_traffic_data,
                        type : 'spline',
                        tooltip : {
                            valueDecimals : 2
                        },
                        color: 'rgb(0, 162, 232)',
                        id : 'totaltrafficseries'
                    },{
                        name : 'Download traffic',
                        data : download_traffic_data,
                        type : 'spline',
                        tooltip : {
                            valueDecimals : 2
                        },
                        color: 'rgb(1, 231, 116)',
                    },{
                        name : 'Upload traffic',
                        data : upload_traffic_data,
                        type : 'spline',
                        tooltip : {
                            valueDecimals : 2
                        },
                        color: 'rgb(215, 57, 53)',
                    },{
                        name: 'Events',
                        type: 'flags',
                        data: eventflags,
                        onSeries : 'totaltrafficseries',
                        shape : 'circlepin',
                        width : 12
                    },{
                        name : 'Local ISP ping',
                        data : average_ping_local_data,
                        type : 'spline',
                        tooltip : {
                            valueDecimals : 2
                        },
                        yAxis: 1
                    },{
                        name : 'Remote 8.8.8.8 ping',
                        data : average_ping_remote_data,
                        type : 'spline',
                        tooltip : {
                            valueDecimals : 2
                        },
                        yAxis: 1
                    },{
                        name : 'Consumed',
                        data : diff_traffic_data,
                        type : 'column',
                        yAxis: 2
                    }],
                    tooltip: {
                        formatter: function() {
                            var o = '';
                            o += tick(this.x).toString()
                            o += '<br>'
                            if (this.points != undefined) {
                                for (var i = 0; i < this.points.length; i++) {
                                    var p = this.points[i]
                                    var s = p.series
                                    o += '<strong>'
                                    o += s.name
                                    o += '</strong>'
                                    o += ' : '

                                    if (s.yAxis.axisTitle.textStr == 'Ping RTT') {
                                        o += time(p.y)
                                    } else if (s.yAxis.axisTitle.textStr == 'Accumulated Traffic'){
                                        o += bytes(p.y, true)
                                    } else {
                                        o += speed(p.y, true)
                                    }
                                    o += '<br>'
                                };
                            } else {
                                o += this.point.text
                            }

                            return o;
                        }
                    },

                    legend: {
                        enabled: true
                    },

                    rangeSelector: {
                        buttons: [{
                            type: 'day',
                            count: 1,
                            text: '1d'
                        },{
                            type: 'week',
                            count: 1,
                            text: '1w'
                        },{
                            type: 'month',
                            count: 1,
                            text: '1m'
                        },{
                            type: 'all',
                            text: 'All'
                        }],
                        selected: 0
                    },

                    yAxis: [{
                        opposite: false,
                         tickPositioner: function(min, max) {

                            var v = Math.pow(1024, Math.floor(Math.log(max)/Math.log(1024)))
                            var vv = Math.ceil(max / v) * v;
                            var vd = vv / 5;
                            var tickPositions = [0];

                            for (pos = 0; pos <= vv+vd; pos += vd) {
                                tickPositions.push(pos);
                            }
                            return tickPositions;

                        },
                        labels: {
                            formatter: function() { return bytes(this.value, true); }
                        },
                        height: '50%',
                        title: {text: 'Accumulated Traffic'},
                        min: 0
                    },{
                        opposite: false,
                        top: '55%',
                        offset: 0,
                        height: '20%',
                        labels: {
                            formatter: function() { return time(this.value); }
                        },
                        title: {text: 'Ping RTT'},
                        gridLineDashStyle: 'LongDashDot',
                        min: 0
                    },{
                        opposite: false,
                        top: '80%',
                        offset: 0,
                        height: '20%',
                        labels: {
                            formatter: function() { return speed(this.value, true); }
                        },
                        title: {text: 'Average Download Speed'},
                        min: 0
                    }]
                });



            });

        </script>
    </body>
</html>